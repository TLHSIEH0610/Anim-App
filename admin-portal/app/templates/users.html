{% extends "base.html" %}

{% block content %}
<h2 class="mdc-typography--headline5">User Management</h2>

<div class="mdc-data-table">
    <div class="mdc-data-table__table-container">
        <table class="mdc-data-table__table">
            <thead>
                <tr class="mdc-data-table__header-row">
                    <th class="mdc-data-table__header-cell">ID</th>
                    <th class="mdc-data-table__header-cell">Email</th>
                    <th class="mdc-data-table__header-cell">Role</th>
                    <th class="mdc-data-table__header-cell">Credits</th>
                    <th class="mdc-data-table__header-cell">Integrity</th>
                    <th class="mdc-data-table__header-cell">Last Login</th>
                    <th class="mdc-data-table__header-cell">Verified</th>
                    <th class="mdc-data-table__header-cell">Books</th>
                    <th class="mdc-data-table__header-cell">Actions</th>
                </tr>
            </thead>
            <tbody class="mdc-data-table__content">
                {% for user in users %}
                <tr class="mdc-data-table__row">
                    <td class="mdc-data-table__cell">{{ user.id }}</td>
                    <td class="mdc-data-table__cell">{{ user.email }}</td>
                    <td class="mdc-data-table__cell">
                        {% set role = (user.role or 'user') %}
                        {% if role == 'superadmin' %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-error);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">superadmin</span>
                            </span>
                        </div>
                        {% elif role == 'admin' %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">admin</span>
                            </span>
                        </div>
                        {% else %}
                        <div class="mdc-chip">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">user</span>
                            </span>
                        </div>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">{{ user.credits }}</td>
                    <td class="mdc-data-table__cell">
                        {% if user.attestation and user.attestation.last_play_integrity_at %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">attested</span>
                            </span>
                        </div>
                        <div class="muted small">{{ user.attestation.last_play_integrity_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">
                        {% if user.last_login_at %}
                        <div class="muted small">{{ user.last_login_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">
                        {% if user.card_verified_at %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">verified</span>
                            </span>
                        </div>
                        <div class="muted small">{{ user.card_verified_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell aa-wrap">
                        {% if user.books %}
                        <div class="books-list">
                            {% for book in user.books %}
                            <div class="book-line">
                                <a href="/books/{{ book.id }}/workflow">{{ book.title }}</a>
                                <span class="muted">({{ book.status }})</span>
                                <span>&nbsp;|&nbsp;</span><a href="/books/{{ book.id }}/images">Images</a>
                                <span>&nbsp;|&nbsp;</span><a href="/books/{{ book.id }}/story">Story</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <em>No books</em>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">
                        <div class="actions-wrap">
                          <button class="mdc-button btn-sm" type="button" data-toggle="#edit-{{ user.id }}"><span class="mdc-button__label">Edit</span></button>
                          <form method="post" action="/users/{{ user.id }}/export">
                            <button type="submit" class="mdc-button btn-sm"><span class="mdc-button__label">Export</span></button>
                          </form>
                          <form method="post" action="/users/{{ user.id }}/delete" onsubmit="return confirm('Delete this user and all associated data? This cannot be undone.');">
                            <button type="submit" class="mdc-button mdc-button--raised btn-sm" style="background-color: var(--mdc-theme-error); color: #fff;"><span class="mdc-button__label">Delete</span></button>
                          </form>
                        </div>
                    </td>
                </tr>
                <tr id="edit-{{ user.id }}" class="row-expand hidden">
                    <td class="mdc-data-table__cell" colspan="9">
                        <form method="post" action="/users/{{ user.id }}/update" class="form-grid one-col">
                            <div class="full">
                                <label for="email-{{ user.id }}">Email</label>
                                <input id="email-{{ user.id }}" type="email" name="email" value="{{ user.email }}" required>
                            </div>
                            {% if is_super_admin %}
                            <div class="full">
                                <label for="role-{{ user.id }}">Role</label>
                                <select id="role-{{ user.id }}" name="role">
                                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>user</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>admin</option>
                                </select>
                            </div>
                            {% endif %}
                            <div class="full">
                                <label for="credits-{{ user.id }}">Credits</label>
                                <input id="credits-{{ user.id }}" type="number" name="credits" value="{{ user.credits }}" min="0">
                            </div>
                            <div class="full">
                                <div class="muted" style="margin-top: .5rem;">Attestation (last seen)</div>
                                {% if user.attestation %}
                                <div class="aa-wrap small">
                                    <div>Platform: <strong>{{ user.attestation.device_platform or 'n/a' }}</strong></div>
                                    <div>App Package: <code>{{ user.attestation.app_package or 'n/a' }}</code></div>
                                    <div>Install ID: <code>{{ user.attestation.install_id or 'n/a' }}</code></div>
                                    <div>Last Play Integrity: <span class="muted">{{ user.attestation.last_play_integrity_at or 'never' }}</span></div>
                                </div>
                                {% else %}
                                <div class="aa-wrap small"><em>No attestation recorded</em></div>
                                {% endif %}
                            </div>
                            <div class="full">
                                <div class="muted" style="margin-top: .5rem;">Card Verification</div>
                                {% if user.card_verified_at %}
                                  <div class="aa-wrap small">
                                    <div>Verified at: <span class="muted">{{ user.card_verified_at }}</span></div>
                                  </div>
                                {% else %}
                                  <div class="aa-wrap small"><em>No card verification recorded</em></div>
                                {% endif %}
                            </div>
                            <div class="form-actions full">
                                <button type="submit" class="mdc-button mdc-button--raised btn-sm"><span class="mdc-button__label">Save</span></button>
                                <button type="button" class="mdc-button btn-sm" data-toggle="#edit-{{ user.id }}"><span class="mdc-button__label">Cancel</span></button>
                            </div>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<a href="/dashboard" class="mdc-button" style="margin-top: 2rem;">Back to dashboard</a>
{% endblock %}
