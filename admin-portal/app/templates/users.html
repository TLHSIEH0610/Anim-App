{% extends "base.html" %}

{% block content %}
<h2 class="mdc-typography--headline5">User Management</h2>

<div class="mdc-card" style="padding:12px 16px; margin: 12px 0 16px;">
  <form id="user-filters" class="form-grid one-col" onsubmit="return false;">
    <div>
      <label for="filter-email">Filter by email</label>
      <input id="filter-email" type="text" placeholder="example@domain.com" />
    </div>
    <div class="badge-group" style="margin-top:6px;">
      <span class="badge-group__label">Flags</span>
      <label class="badge"><input type="checkbox" id="filter-attested" /> Integrity</label>
      <label class="badge"><input type="checkbox" id="filter-verified" /> Verified</label>
      <label class="badge"><input type="checkbox" id="filter-hasbooks" /> Has books</label>
      <span class="badge" id="filter-count" style="margin-left:auto;">&nbsp;</span>
    </div>
  </form>
  <script>
    (function(){
      function applyFilters(){
        const email = (document.getElementById('filter-email').value || '').trim().toLowerCase();
        const needAttested = document.getElementById('filter-attested').checked;
        const needVerified = document.getElementById('filter-verified').checked;
        const needBooks = document.getElementById('filter-hasbooks').checked;
        const rows = document.querySelectorAll('tr.user-row');
        let shown = 0;
        rows.forEach(function(row){
          const rowEmail = row.getAttribute('data-email') || '';
          const attested = row.getAttribute('data-attested') === 'true';
          const verified = row.getAttribute('data-verified') === 'true';
          const hasbooks = row.getAttribute('data-hasbooks') === 'true';
          let ok = true;
          if (email && !rowEmail.includes(email)) ok = false;
          if (needAttested && !attested) ok = false;
          if (needVerified && !verified) ok = false;
          if (needBooks && !hasbooks) ok = false;
          const editId = row.getAttribute('data-edit-id');
          const editRow = editId ? document.getElementById(editId) : null;
          if (ok){
            row.style.display = '';
            if (editRow) editRow.style.display = '';
            shown++;
          } else {
            row.style.display = 'none';
            if (editRow) editRow.style.display = 'none';
          }
        });
        const badge = document.getElementById('filter-count');
        if (badge){ badge.textContent = shown + ' shown'; }
      }
      document.addEventListener('DOMContentLoaded', function(){
        ['filter-email','filter-attested','filter-verified','filter-hasbooks'].forEach(function(id){
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', applyFilters);
          el.addEventListener('change', applyFilters);
        });
        applyFilters();
      });
    })();
  </script>
</div>

<div class="mdc-data-table">
    <div class="mdc-data-table__table-container">
        <table class="mdc-data-table__table">
            <thead>
                <tr class="mdc-data-table__header-row">
                    <th class="mdc-data-table__header-cell">ID</th>
                    <th class="mdc-data-table__header-cell">Email</th>
                    <th class="mdc-data-table__header-cell">Role</th>
                    <th class="mdc-data-table__header-cell">Credits</th>
                    <th class="mdc-data-table__header-cell">Integrity</th>
                    <th class="mdc-data-table__header-cell">Last Login</th>
                    <th class="mdc-data-table__header-cell">Verified</th>
                    <th class="mdc-data-table__header-cell">Books</th>
                    <th class="mdc-data-table__header-cell">Actions</th>
                </tr>
            </thead>
            <tbody class="mdc-data-table__content">
                {% for user in users %}
                {% set attested = 1 if (user.attestation and user.attestation.last_play_integrity_at) else 0 %}
                {% set verified = 1 if user.card_verified_at else 0 %}
                {% set hasbooks = 1 if (user.book_count and user.book_count > 0) else 0 %}
                <tr class="mdc-data-table__row user-row" data-email="{{ (user.email or '') | lower }}" data-attested="{{ 'true' if attested else 'false' }}" data-verified="{{ 'true' if verified else 'false' }}" data-hasbooks="{{ 'true' if hasbooks else 'false' }}" data-edit-id="edit-{{ user.id }}">
                    <td class="mdc-data-table__cell">{{ user.id }}</td>
                    <td class="mdc-data-table__cell aa-wrap">{{ user.email }}</td>
	                    <td class="mdc-data-table__cell">
	                        {% set role = (user.role or 'user') %}
	                        {% if role == 'superadmin' %}
	                        <div class="mdc-chip" style="background-color: var(--mdc-theme-error);">
	                            <div class="mdc-chip__ripple"></div>
	                            <span role="gridcell">
	                                <span class="mdc-chip__text">superadmin</span>
	                            </span>
	                        </div>
	                        {% elif role == 'admin' %}
	                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
	                            <div class="mdc-chip__ripple"></div>
	                            <span role="gridcell">
	                                <span class="mdc-chip__text">admin</span>
	                            </span>
	                        </div>
	                        {% elif role == 'system' %}
	                        <div class="mdc-chip" style="background-color: #374151;">
	                            <div class="mdc-chip__ripple"></div>
	                            <span role="gridcell">
	                                <span class="mdc-chip__text">system</span>
	                            </span>
	                        </div>
	                        {% else %}
	                        <div class="mdc-chip">
	                            <div class="mdc-chip__ripple"></div>
	                            <span role="gridcell">
	                                <span class="mdc-chip__text">user</span>
	                            </span>
	                        </div>
	                        {% endif %}
	                    </td>
                    <td class="mdc-data-table__cell">{{ user.credits }}</td>
                    <td class="mdc-data-table__cell">
                        {% if user.attestation and user.attestation.last_play_integrity_at %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">attested</span>
                            </span>
                        </div>
                        <div class="muted small">{{ user.attestation.last_play_integrity_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">
                        {% if user.last_login_at %}
                        <div class="muted small">{{ user.last_login_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">
                        {% if user.card_verified_at %}
                        <div class="mdc-chip" style="background-color: var(--mdc-theme-secondary);">
                            <div class="mdc-chip__ripple"></div>
                            <span role="gridcell">
                                <span class="mdc-chip__text">verified</span>
                            </span>
                        </div>
                        <div class="muted small">{{ user.card_verified_at }}</div>
                        {% else %}
                        <span class="muted">—</span>
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell aa-wrap">
                        {% if user.books %}
                        <div class="books-list">
                            {% for book in user.books %}
                            <div class="book-line">
                                <a href="/books/{{ book.id }}/workflow">{{ book.title }}</a>
                                <span class="muted">({{ book.status }})</span>
                                <span>&nbsp;|&nbsp;</span><a href="/books/{{ book.id }}/images">Images</a>
                                <span>&nbsp;|&nbsp;</span><a href="/books/{{ book.id }}/story">Story</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <em>No books</em>
                        {% endif %}
                    </td>
	                    <td class="mdc-data-table__cell">
	                        <div class="actions-wrap">
	                          {% if role != 'system' %}
	                          <button class="mdc-button btn-sm" type="button" data-toggle="#edit-{{ user.id }}"><span class="mdc-button__label">Edit</span></button>
	                          {% endif %}
	                          <form method="post" action="/users/{{ user.id }}/export">
	                            <button type="submit" class="mdc-button btn-sm"><span class="mdc-button__label">Export</span></button>
	                          </form>
	                          {% if role != 'system' %}
	                          <form method="post" action="/users/{{ user.id }}/delete" onsubmit="return confirm('Delete this user and all associated data? This cannot be undone.');">
	                            <button type="submit" class="mdc-button mdc-button--raised btn-sm" style="background-color: var(--mdc-theme-error); color: #fff;"><span class="mdc-button__label">Delete</span></button>
	                          </form>
	                          {% else %}
	                          <span class="muted small">System user (not deletable)</span>
	                          {% endif %}
	                        </div>
	                    </td>
	                </tr>
	                <tr id="edit-{{ user.id }}" class="row-expand hidden">
	                    <td class="mdc-data-table__cell" colspan="9">
	                        {% if role == 'system' %}
	                        <div class="muted">This is a system tombstone account used to retain anonymized payment/support records.</div>
	                        {% else %}
	                        <form method="post" action="/users/{{ user.id }}/update" class="form-grid one-col">
                            <div class="full">
                                <label for="email-{{ user.id }}">Email</label>
                                <input id="email-{{ user.id }}" type="email" name="email" value="{{ user.email }}" required>
                            </div>
                            {% if is_super_admin %}
                            <div class="full">
                                <label for="role-{{ user.id }}">Role</label>
                                <select id="role-{{ user.id }}" name="role">
                                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>user</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>admin</option>
                                </select>
                            </div>
                            {% endif %}
                            <div class="full">
                                <label for="credits-{{ user.id }}">Credits</label>
                                <input id="credits-{{ user.id }}" type="number" name="credits" value="{{ user.credits }}" min="0">
                            </div>
                            <div class="full">
                                <div class="muted" style="margin-top: .5rem;">Attestation (last seen)</div>
                                {% if user.attestation %}
                                <div class="aa-wrap small">
                                    <div>Platform: <strong>{{ user.attestation.device_platform or 'n/a' }}</strong></div>
                                    <div>App Package: <code>{{ user.attestation.app_package or 'n/a' }}</code></div>
                                    <div>Install ID: <code>{{ user.attestation.install_id or 'n/a' }}</code></div>
                                    <div>Last Play Integrity: <span class="muted">{{ user.attestation.last_play_integrity_at or 'never' }}</span></div>
                                </div>
                                {% else %}
                                <div class="aa-wrap small"><em>No attestation recorded</em></div>
                                {% endif %}
                            </div>
                            <div class="full">
                                <div class="muted" style="margin-top: .5rem;">Card Verification</div>
                                {% if user.card_verified_at %}
                                  <div class="aa-wrap small">
                                    <div>Verified at: <span class="muted">{{ user.card_verified_at }}</span></div>
                                  </div>
                                {% else %}
                                  <div class="aa-wrap small"><em>No card verification recorded</em></div>
                                {% endif %}
                            </div>
	                            <div class="form-actions full">
	                                <button type="submit" class="mdc-button mdc-button--raised btn-sm"><span class="mdc-button__label">Save</span></button>
	                                <button type="button" class="mdc-button btn-sm" data-toggle="#edit-{{ user.id }}"><span class="mdc-button__label">Cancel</span></button>
	                            </div>
	                        </form>
	                        <div class="form-actions full" style="margin-top:8px;">
	                          <form method="post" action="/users/{{ user.id }}/clear-free-trial" data-loading="Clearing...">
	                            <button type="submit" class="mdc-button btn-sm"><span class="mdc-button__label">Clear Free-Trial Usage</span></button>
	                            <span class="muted small">Removes user's in-account flags and persisted usage records.</span>
	                          </form>
	                        </div>
	                        {% endif %}
	                    </td>
	                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<a href="/dashboard" class="mdc-button" style="margin-top: 2rem;">Back to dashboard</a>
{% endblock %}
