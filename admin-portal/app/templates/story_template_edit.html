{% extends "base.html" %}

{% block content %}
<h2 class="mdc-typography--headline5">Edit Story Template</h2>

<form method="post" action="/stories/{{ story.slug }}" enctype="multipart/form-data" class="form-grid one-col mt-3">
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="name" name="name" value="{{ story.name }}" class="mdc-text-field__input" required>
      <label for="name" class="mdc-floating-label">Name</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="slug" name="slug" value="{{ story.slug }}" class="mdc-text-field__input" required>
      <label for="slug" class="mdc-floating-label">Slug</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <label for="description">Description</label>
    <textarea id="description" name="description">{{ story.description }}</textarea>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="age" name="age" value="{{ story.age }}" class="mdc-text-field__input">
      <label for="age" class="mdc-floating-label">Age</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="version" name="version" type="number" min="1" value="{{ story.version or 1 }}" class="mdc-text-field__input" required>
      <label for="version" class="mdc-floating-label">Version</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="workflow_slug" name="workflow_slug" value="{{ story.workflow_slug }}" class="mdc-text-field__input">
      <label for="workflow_slug" class="mdc-floating-label">Workflow Slug</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <label for="is_active">Active</label>
    <select id="is_active" name="is_active">
      <option value="true" {% if story.is_active %}selected{% endif %}>True</option>
      <option value="false" {% if not story.is_active %}selected{% endif %}>False</option>
    </select>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="price_dollars" name="price_dollars" type="number" step="0.01" min="0" value="{{ '%.2f' % story.price_dollars if story.price_dollars is not none else '' }}" class="mdc-text-field__input" required>
      <label for="price_dollars" class="mdc-floating-label">Base Price (AUD)</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="discount_price" name="discount_price" type="number" step="0.01" min="0" value="{{ '%.2f' % story.discount_price if story.discount_price is not none else '' }}" class="mdc-text-field__input">
      <label for="discount_price" class="mdc-floating-label">Discount Price (AUD)</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="free_trial_slug" name="free_trial_slug" value="{{ story.free_trial_slug or '' }}" class="mdc-text-field__input">
      <label for="free_trial_slug" class="mdc-floating-label">Free Trial Slug</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <label for="pages">Pages JSON</label>
    <textarea id="pages" name="pages" style="min-height:320px;">{{ story.pages | tojson(indent=2) }}</textarea>
  </div>

  <div class="full">
    <label for="cover_image_url">Cover Image Path (optional)</label>
    <input id="cover_image_url" name="cover_image_url" value="{{ story.cover_image_url or '' }}" placeholder="/data/media/covers/winter_wish.png">
    <div class="form-help" style="opacity:.75; font-size:.9rem; margin-top:6px">Provide a file path within MEDIA_ROOT so it can be served via the file proxy.</div>
  </div>

  <div class="full">
    <label for="cover_file">Or upload a new cover image</label>
    <input id="cover_file" name="cover_file" type="file" accept="image/*">
  </div>
  {% if story.cover_image_url %}
    <div class="full">
      <div class="form-help" style="opacity:.75; font-size:.9rem">Current cover preview:</div>
      <img src="/files-proxy?path={{ story.cover_image_url }}" alt="Cover preview" style="max-width: 320px; display:block; border-radius:10px;" onerror="this.style.display='none'">
    </div>
  {% endif %}

  <div class="form-help full">
    <strong>Available template variables</strong>
    <p>Use these placeholders inside story text and prompts. They are populated when a user creates a book:</p>
    <ul>
      <li><code>{Name}</code> – lead character name collected from the book creator UI.</li>
      <li><code>{name}</code> – same as <code>{Name}</code>, useful for inline lowercase text.</li>
      <li><code>{gender}</code> – descriptive word such as “boy”, “girl”, or “child” based on the selected pronouns.</li>
      <li><code>{they}</code>, <code>{them}</code>, <code>{their}</code>, <code>{theirs}</code> (and capitalised variants) – pronouns derived from the chosen gender.</li>
    </ul>
    <p>Each page object may include <code>"image_kp"</code> to reference a keypoint image slug (from the Keypoint Images section). Leave it blank for automatic pose detection.</p>
    <p><code>"positive_prompt"</code> feeds the CLIPText node used for guidance (node 40 in your workflow).</p>
    <p>Include an optional <code>"seed"</code> on each page object (e.g. <code>239971716923143</code>) when you want deterministic ComfyUI renders; omit it to keep random seeds.</p>
  </div>

  <div class="form-actions full">
    <button type="submit" class="mdc-button mdc-button--raised"><span class="mdc-button__label">Save Story Template</span></button>
  </div>
</form>

<form method="post" action="/stories/{{ story.slug }}/export" class="mt-3">
  <button type="submit" class="mdc-button mdc-button--outlined"><span class="mdc-button__label">Export story fixture</span></button>
</form>

<a href="/stories" class="mdc-button mt-4"><span class="mdc-button__label">Back to stories</span></a>
{% endblock %}
