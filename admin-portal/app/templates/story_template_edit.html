{% extends "base.html" %}

{% block content %}
<h2 class="mdc-typography--headline5">Edit Story Template</h2>

<form method="post" action="/stories/{{ story.slug }}" enctype="multipart/form-data" class="form-grid one-col mt-3">
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="name" name="name" value="{{ (form_defaults.name if form_defaults and form_defaults.name is not none else story.name) }}" class="mdc-text-field__input" required>
      <label for="name" class="mdc-floating-label">Name</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="slug" name="slug" value="{{ (form_defaults.slug if form_defaults and form_defaults.slug is not none else story.slug) }}" class="mdc-text-field__input" required>
      <label for="slug" class="mdc-floating-label">Slug</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <label for="description">Description</label>
    <textarea id="description" name="description">{{ (form_defaults.description if form_defaults and form_defaults.description is not none else story.description) }}</textarea>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="age" name="age" value="{{ (form_defaults.age if form_defaults and form_defaults.age is not none else story.age) }}" class="mdc-text-field__input">
      <label for="age" class="mdc-floating-label">Age</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="version" name="version" type="number" min="1" value="{{ (form_defaults.version if form_defaults and form_defaults.version is not none else (story.version or 1)) }}" class="mdc-text-field__input" required>
      <label for="version" class="mdc-floating-label">Version</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <label for="workflow_slug">Workflow</label>
    <select id="workflow_slug" name="workflow_slug">
      {% set selected_wf = (form_defaults.workflow_slug if form_defaults and form_defaults.workflow_slug is not none else story.workflow_slug) %}
      {% for wf in workflows %}
        <option value="{{ wf.slug }}" {% if wf.slug == selected_wf %}selected{% endif %}>{{ wf.slug }} (v{{ wf.version }})</option>
      {% endfor %}
    </select>
  </div>
  <div class="full">
    <label for="is_active">Active</label>
    <select id="is_active" name="is_active">
      <option value="true" {% if story.is_active %}selected{% endif %}>True</option>
      <option value="false" {% if not story.is_active %}selected{% endif %}>False</option>
    </select>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="price_dollars" name="price_dollars" type="number" step="0.01" min="0" value="{{ (form_defaults.price_dollars if form_defaults and form_defaults.price_dollars is not none else ('%.2f' % story.price_dollars if story.price_dollars is not none else '')) }}" class="mdc-text-field__input" required>
      <label for="price_dollars" class="mdc-floating-label">Base Price (AUD)</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>
  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="discount_price" name="discount_price" type="number" step="0.01" min="0" value="{{ (form_defaults.discount_price if form_defaults and form_defaults.discount_price is not none else ('%.2f' % story.discount_price if story.discount_price is not none else '')) }}" class="mdc-text-field__input">
      <label for="discount_price" class="mdc-floating-label">Discount Price (AUD)</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <div class="mdc-text-field mdc-text-field--filled w-100">
      <input id="free_trial_slug" name="free_trial_slug" value="{{ (form_defaults.free_trial_slug if form_defaults and form_defaults.free_trial_slug is not none else (story.free_trial_slug or '')) }}" class="mdc-text-field__input">
      <label for="free_trial_slug" class="mdc-floating-label">Free Trial Slug</label>
      <div class="mdc-line-ripple"></div>
    </div>
  </div>

  <div class="full">
    <label for="pages">Pages JSON</label>
    <textarea id="pages" name="pages" style="min-height:320px;">{{ (form_defaults.pages if form_defaults and form_defaults.pages is not none else (story.pages | tojson(indent=2))) }}</textarea>
  </div>

  <div class="full">
    <label for="cover_image_url">Cover Image Path (optional)</label>
    <input id="cover_image_url" name="cover_image_url" value="{{ story.cover_image_url or '' }}" placeholder="/data/media/covers/winter_wish.png">
    <div class="form-help" style="opacity:.75; font-size:.9rem; margin-top:6px">Provide a file path within MEDIA_ROOT so it can be served via the file proxy.</div>
  </div>

  <div class="full">
    <label for="cover_file">Or upload a new cover image</label>
    <input id="cover_file" name="cover_file" type="file" accept="image/*">
  </div>
  {% if story.cover_image_url %}
    <div class="full">
      <div class="form-help" style="opacity:.75; font-size:.9rem">Current cover preview:</div>
      <img src="/files-proxy?path={{ story.cover_image_url }}" alt="Cover preview" style="max-width: 320px; display:block; border-radius:10px;" onerror="this.style.display='none'">
    </div>
  {% endif %}

  <div class="full">
    <label>Demo Images (optional)</label>
    <div class="aa-grid aa-grid--sm">
      <div>
        <input id="demo_file_1" name="demo_file_1" type="file" accept="image/*">
        {% if story.demo_images and story.demo_images[0] %}
          <img src="/files-proxy?path={{ story.demo_images[0] }}" alt="Demo 1" style="max-width: 180px; display:block; border-radius:10px; margin-top:6px;" onerror="this.style.display='none'">
        {% endif %}
      </div>
      <div>
        <input id="demo_file_2" name="demo_file_2" type="file" accept="image/*">
        {% if story.demo_images and story.demo_images[1] %}
          <img src="/files-proxy?path={{ story.demo_images[1] }}" alt="Demo 2" style="max-width: 180px; display:block; border-radius:10px; margin-top:6px;" onerror="this.style.display='none'">
        {% endif %}
      </div>
      <div>
        <input id="demo_file_3" name="demo_file_3" type="file" accept="image/*">
        {% if story.demo_images and story.demo_images[2] %}
          <img src="/files-proxy?path={{ story.demo_images[2] }}" alt="Demo 3" style="max-width: 180px; display:block; border-radius:10px; margin-top:6px;" onerror="this.style.display='none'">
        {% endif %}
      </div>
      <div>
        <input id="demo_file_4" name="demo_file_4" type="file" accept="image/*">
        {% if story.demo_images and story.demo_images[3] %}
          <img src="/files-proxy?path={{ story.demo_images[3] }}" alt="Demo 4" style="max-width: 180px; display:block; border-radius:10px; margin-top:6px;" onerror="this.style.display='none'">
        {% endif %}
      </div>
    </div>
  </div>

  <div class="form-help full">
    <strong>Available template variables</strong>
    <p>Use these placeholders inside story text and prompts. They are populated when a user creates a book:</p>
    <ul>
      <li><code>{Name}</code> – lead character name collected from the book creator UI.</li>
      <li><code>{name}</code> – same as <code>{Name}</code>, useful for inline lowercase text.</li>
      <li><code>{gender}</code> – descriptive word such as “boy”, “girl”, or “child” based on the selected pronouns.</li>
      <li><code>{they}</code>, <code>{them}</code>, <code>{their}</code>, <code>{theirs}</code> (and capitalised variants) – pronouns derived from the chosen gender.</li>
    </ul>
    <p>For Qwen-based workflows, each page object should include <code>"story_image"</code> to reference a Story Image slug (from the Story Images section). This becomes the body/background reference for that page.</p>
    <p><code>"positive_prompt"</code> and <code>"negative_prompt"</code> are optional overrides for the workflow’s default text. Leave them out to use the defaults baked into the workflow (for example, the prompt on node 348 in a Qwen graph).</p>
    <p>You can also attach a human-readable <code>"description"</code> per page for internal notes or future UI tooling.</p>
  </div>

  <div class="form-actions full">
    <button type="submit" class="mdc-button mdc-button--raised"><span class="mdc-button__label">Save Story Template</span></button>
  </div>
</form>

<form method="post" action="/stories/{{ story.slug }}/export" class="mt-3">
  <button type="submit" class="mdc-button mdc-button--outlined"><span class="mdc-button__label">Export story fixture</span></button>
</form>

<a href="/stories" class="mdc-button mt-4"><span class="mdc-button__label">Back to stories</span></a>
{% endblock %}
