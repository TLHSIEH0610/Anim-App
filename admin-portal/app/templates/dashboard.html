{% extends "base.html" %}

{% block content %}
<h2 class="mdc-typography--headline5">Books Overview</h2>

{% if books %}
<div class="mdc-data-table">
    <div class="mdc-data-table__table-container">
        <table class="mdc-data-table__table">
            <thead>
                <tr class="mdc-data-table__header-row">
                    <th class="mdc-data-table__header-cell">ID</th>
                    <th class="mdc-data-table__header-cell">Title</th>
                    <th class="mdc-data-table__header-cell">Status</th>
                    <th class="mdc-data-table__header-cell">Story</th>
                    <th class="mdc-data-table__header-cell">Created</th>
                    <th class="mdc-data-table__header-cell">Actions</th>
                </tr>
            </thead>
            <tbody class="mdc-data-table__content">
                {% for book in books %}
                <tr class="mdc-data-table__row">
                    <td class="mdc-data-table__cell">{{ book.id }}</td>
                    <td class="mdc-data-table__cell">{{ book.title }}</td>
                    <td class="mdc-data-table__cell">
                        {% set s = (book.status or '').lower() %}
                        {% set pct = (book.progress_percentage or 0) | int %}
                        {% set badge_class = 'badge--unknown' %}
                        {% if s in ['creating','generating_story','generating_images','composing','queued','running'] %}
                          {% set badge_class = 'badge--inprogress' %}
                        {% elif s == 'completed' %}
                          {% set badge_class = 'badge--done' %}
                        {% elif s == 'failed' %}
                          {% set badge_class = 'badge--failed' %}
                        {% endif %}
                        <div class="badge {{ badge_class }}">
                          <span style="text-transform:capitalize;">{{ s or 'unknown' }}</span>
                          {% if s != 'completed' and s != 'failed' %}
                          <span class="progress-mini" aria-label="{{ pct }}%">
                            <i style="width: {{ pct }}%"></i>
                          </span>
                          {% endif %}
                        </div>
                    </td>
                    <td class="mdc-data-table__cell">
                        {% if book.story_source == 'template' %}
                          {% set tv = book.template_version or book.version %}
                          {{ book.template_name or book.template_key or 'Template' }}
                          <span class="muted">({{ book.template_key }}{% if tv %} v{{ tv }}{% endif %})</span>
                        {% else %}
                          Custom
                        {% endif %}
                    </td>
                    <td class="mdc-data-table__cell">{{ book.created_display or book.created_at or '-' }}</td>
                    <td class="mdc-data-table__cell">
                        <div class="actions-wrap">
                          <a href="/books/{{ book.id }}/workflow" class="mdc-button btn-sm"><span class="mdc-button__label">Workflow</span></a>
                          <a href="/books/{{ book.id }}/images" class="mdc-button btn-sm"><span class="mdc-button__label">Images</span></a>
                          <form method="post" action="/books/{{ book.id }}/regenerate">
                            <button class="mdc-button btn-sm" type="submit"><span class="mdc-button__label">Regenerate</span></button>
                          </form>
                          <form method="post" action="/books/{{ book.id }}/delete" onsubmit="return confirm('Delete book {{ book.title }}?');">
                            <button class="mdc-button btn-sm btn-danger" type="submit"><span class="mdc-button__label">Delete</span></button>
                          </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<p class="mdc-typography--body1">No books found.</p>
{% endif %}

{% endblock %}
