# Agent Ready Notes

Curated pointers for working on AnimApp without re-reading every guide. Update this file whenever new platform or architectural features land.

## 1. Core System Shape (from `README.md`)
- React Native + Expo frontend talks to FastAPI backend over REST (`/books`, `/billing`, `/auth`).
- Story text and prompts come from **database-backed templates** (see `story_templates` tables), while ComfyUI handles illustration via the seeded `base` workflow.
- Background work: Redis + RQ (`jobs`, `books` queues). ReportLab assembles PDFs once ComfyUI image jobs finish.
- Payments funnel through Stripe (card), credits, or free-trial flags. Billing endpoints unify the quote payload for the mobile UI.

## 2. Environments & Secrets
- **No `.env.example` files are committed.** Create them manually:
  - `infra/.env` (used by docker-compose) needs `POSTGRES_*`, `DATABASE_URL`, `REDIS_URL`, `COMFYUI_SERVER`, `MEDIA_ROOT`, `ADMIN_API_KEY`, Stripe keys, etc.
  - `backend/.env` is generated by `python backend/setup_platform.py` (or create manually if skipping the helper). Include `GOOGLE_OAUTH_CLIENT_IDS` so `/auth/google` can validate the ID token audience.
  - `frontend/.env` must set at least `EXPO_PUBLIC_API_BASE` and `EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY`, plus Google OAuth client IDs.
- Story templates/workflows are seeded by the backend on startup; file-based fallbacks via `COMFYUI_WORKFLOW` are optional.
- Backend verifies Google sign-in tokens via `/auth/google` by calling Google's tokeninfo endpoint and auto-provisioning users.

## 3. Local + Docker Workflows
- **Local dev (from `README.md`, `CROSS_PLATFORM_SETUP.md`):**
  1. `python -m venv venv && pip install -r backend/requirements.txt`
  2. `python backend/setup_platform.py` (creates backend/.env, media/workflow dirs)
  3. Run Postgres, Redis, ComfyUI (native)
  4. `uvicorn app.main:app --reload`, `rq worker jobs books --url redis://localhost:6379/0`, `npm install && npm start`
- **Docker (from `DOCKER_SETUP.md`, reinforced in `CHILDBOOK_SETUP.md`):**
  1. Start ComfyUI separately.
  2. Populate `infra/.env`.
  3. `docker-compose -f infra/docker-compose.local-comfyui.yml up (-d)`.
  4. Frontend still runs via Metro (`npm start`).

## 4. Cross-Platform Paths (from `CROSS_PLATFORM_SETUP.md`)
- Media default: `~/Documents/AnimApp/media` on macOS, `C:\Users\<you>\Documents\AnimApp\media` on Windows. Docker containers use `/data/media`.
- Optional workflow fallback lives beside that media root (`.../workflows/Anmi-App.json`) if you choose to keep one.
- `setup_platform.py` creates these directories and writes backend `.env`.

## 5. Story Template Administration (from `CHILDBOOK_SETUP.md`)
- Templates & workflow definitions live entirely in Postgres; edit them through the admin portal (`/stories`, `/workflows` tabs).
- Placeholders `{Name}`, `{gender}`, `{they}`, etc. get filled per book before ComfyUI runs.
- Illustration styling is driven by the selected workflow; the old `illustration_style` field has been removed from story templates.
- Reseed defaults by invoking `ensure_default_stories`/`ensure_default_workflows` if the DB was wiped.

## 6. Payments (from `PAYMENT_ARCHITECTURE.md`)
- Frontend fetches `GET /billing/quote` for every book before checkout.
- Card flow: `POST /billing/stripe-intent` → `stripe.confirmPayment` → `POST /billing/stripe-confirm`.
- Credits and free trials are backend-enforced; quotes expose pricing/eligibility.
- Stripe secret/publishable keys must be present in `infra/.env`; publishable key also lives in `frontend/.env`.

## 7. Cloudflare Tunnel (from `CLOUDFLARE_TUNNEL.md`)
- Tunnel `kid-to-story` maps `kid-to-story.win` → `http://host.docker.internal:8000`.
- Credentials stored in `%USERPROFILE%\.cloudflared\620de6cc-...json`; config file defines ingress.
- Run locally with `cloudflared tunnel run kid-to-story`; check connectivity via `Invoke-WebRequest https://kid-to-story.win/health`.
- Set `EXPO_PUBLIC_API_BASE=https://kid-to-story.win` when testing remote access.

## 8. Common Troubleshooting Hooks
- **Worker stuck**: `docker-compose ... logs -f worker` (Docker) or `rq worker jobs books --verbose`.
- **Story template missing**: `psql $DATABASE_URL -c "SELECT id, slug, is_active FROM story_templates;"`.
- **ComfyUI connectivity**: `curl http://localhost:8188/system_stats` locally, or run via Cloudflare endpoint.
- **Google sign-in**: ensure Android SHA-1s are registered in Google Cloud (debug vs. EAS keystores) and that `EXPO_PUBLIC_GOOGLE_*_CLIENT_ID` are populated.

> Keep this file synced whenever instructions elsewhere change (new services, env vars, payment routes, etc.) so agents can jump straight here for context.
